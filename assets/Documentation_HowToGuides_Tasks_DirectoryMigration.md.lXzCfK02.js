import{_ as t,c as a,ah as i,o as r}from"./chunks/framework.BWXOFiC5.js";const p=JSON.parse('{"title":"Directory Migration","description":"","frontmatter":{},"headers":[],"relativePath":"Documentation/HowToGuides/Tasks/DirectoryMigration.md","filePath":"Documentation/HowToGuides/Tasks/DirectoryMigration.md"}'),o={name:"Documentation/HowToGuides/Tasks/DirectoryMigration.md"};function n(s,e,l,d,h,c){return r(),a("div",null,e[0]||(e[0]=[i(`<h1 id="directory-migration" tabindex="-1">Directory Migration <a class="header-anchor" href="#directory-migration" aria-label="Permalink to &quot;Directory Migration&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>The Directory Migration Task is intended to move computers from one IDP to another. This will simplify your projects to move computers from Active Directory to Azure AD, or Workgroup to Active Directory, etc. You can find a compatibility matrix below. The task will also migrate the user profiles so that they can get back to work as soon as the migration is complete.</p><h2 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h2><p>An active ImmyBot subscription or <a href="https://www.immy.bot/pricing/" target="_blank" rel="noreferrer">trial</a></p><ul><li>Admin access to your Microsoft Tenant.</li><li>Computers that are migrating cannot be Windows Home.</li><li><a href="/Documentation/Integrations/azure-custom-application-permissions.html">Custom Azure Permissions</a> are set up and established for the tenant.</li><li>If you&#39;re using Enhanced AzureAD Join, you need to set up automatic <a href="https://learn.microsoft.com/en-us/intune/intune-service/enrollment/quickstart-setup-auto-enrollment" target="_blank" rel="noreferrer">Intune Enrollment</a></li><li>Do not have folder redirection set up to a server via GPO.</li><li>Ensure that all available updates are applied to the computer(s).</li></ul><h2 id="deployment-planning" tabindex="-1">Deployment Planning <a class="header-anchor" href="#deployment-planning" aria-label="Permalink to &quot;Deployment Planning&quot;">​</a></h2><h3 id="data-protected-by-windows-dpapi" tabindex="-1">Data Protected by Windows DPAPI <a class="header-anchor" href="#data-protected-by-windows-dpapi" aria-label="Permalink to &quot;Data Protected by Windows DPAPI&quot;">​</a></h3><p>Windows DPAPI (Data Protection API) user-based encryption binds encrypted data to the user&#39;s domain credentials. When a user&#39;s domain association changes during migration, any data encrypted with DPAPI will become inaccessible.</p><p><strong>Affected Components:</strong></p><ul><li>Windows Hello (biometric authentication, PINs)</li><li>Browser stored passwords (Chrome, Edge, Firefox)</li><li>Saved credentials in Credential Manager</li><li>Application-specific encrypted data</li></ul><h3 id="pre-migration-requirements" tabindex="-1">Pre-Migration Requirements <a class="header-anchor" href="#pre-migration-requirements" aria-label="Permalink to &quot;Pre-Migration Requirements&quot;">​</a></h3><ol><li><p><strong>Enable Browser Sync:</strong> Users must sign into their browsers (Chrome, Edge, etc.) and enable synchronization before migration. This ensures passwords and other encrypted data are backed up to the cloud and can be re-downloaded after migration.</p></li><li><p><strong>Document Windows Hello Usage:</strong> Users will need to reconfigure Windows Hello features, including facial recognition, fingerprint readers, and PINs after migration is complete.</p></li><li><p><strong>Review Credential Manager:</strong> Any credentials stored in Windows Credential Manager should be documented, as these may need to be re-entered post-migration.</p></li></ol><h3 id="dem-user-creation" tabindex="-1">DEM User Creation <a class="header-anchor" href="#dem-user-creation" aria-label="Permalink to &quot;DEM User Creation&quot;">​</a></h3><div class="info custom-block"><p class="custom-block-title">INFO</p><p>You only need to create DEM users if you&#39;re adding these computers to Azure.</p></div><div class="danger custom-block"><p class="custom-block-title">Do not use a Global Administrator</p><p>From a security standpoint, we do NOT recommend using a global admin or existing user as a DEM.</p></div><p>AzureAD/Entra Join DEM User Instructions</p><ol><li>Create a DEM (Device Enrollment Manager) user in the Customer&#39;s Azure AD (Ex. <a href="mailto:dem@contoso.com" target="_blank" rel="noreferrer">dem@contoso.com</a>)</li><li>Assign the DEM user an Intune license (Intune Plan 1 is fine)</li><li>Do NOT make the user a Global Admin (You shouldn&#39;t be bypassing MFA for Global Admins)</li><li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/RolesManagementMenuBlade/~/AllRoles/adminUnitObjectId//resourceScope/%2F" target="_blank" rel="noreferrer">Roles and administrators</a> and assign the Cloud Device Administrator or Cloud PC Administrator role</li><li>Go to <a href="https://intune.microsoft.com/#view/Microsoft_Intune_DeviceSettings/DevicesEnrollmentMenu/~/enrollmentManagers" target="_blank" rel="noreferrer">Device Enrollment Managers</a> and make the user a Device Enrollment Manager</li><li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_Devices/DevicesMenuBlade/~/DeviceSettings/menuId/" target="_blank" rel="noreferrer">MFA Enrollment</a> Settings and verify Require Multi-Factor Authentication to register or join devices with Azure AD is set to &quot;No&quot;</li><li>MANUALLY LOGON AS THE USER AN INCOGNITO WINDOW <ul><li>Verify a password change is not required</li></ul></li><li>Verify the user is not being prompted for MFA or MFA Registration</li></ol><h2 id="parameters" tabindex="-1">Parameters <a class="header-anchor" href="#parameters" aria-label="Permalink to &quot;Parameters&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td><strong>DestinationDirectoryType</strong></td><td>Choose the destination directly type here. ImmyBot will use information available to it to get the computers to the target destination.</td></tr><tr><td><strong>ProfileTypesToMigrate</strong></td><td>For each profile on a machine, ImmyBot gets the SID of the associated user, and determines if that SID is Local, ActiveDirectory, or AzureAD. ImmyBot will not attempt to migrate the machine if it can&#39;t find a target account in the destination directory for every profile. You can avoid this by limiting the profiles using this parameter.</td></tr><tr><td><strong>Workgroup Migrations</strong></td><td>Use this if the computer(s) are in a workgroup. This will allow us to convert generic profiles into named profiles. (e.g., C:\\Users\\JFrontDesk actually belongs to <a href="mailto:jane.doe@company.com" target="_blank" rel="noreferrer">jane.doe@company.com</a>)</td></tr><tr><td><strong>ProfileNamesToAvoid</strong></td><td>Use this to avoid migrating profiles that don&#39;t have a matching identity in the target AzureAD. (Like local admin accounts). Does a case insensitive &quot;Contains&quot; search. For example, C:\\Users\\ITAdmin would be excluded if you enter ITAdmin or admin.</td></tr><tr><td><strong>FuzzyMatch</strong></td><td>Enable this to allow Immy to find usernames in the target directory based on profile foldername</td></tr><tr><td><strong>IgnoreProfilesWithoutMatchingUsers</strong></td><td>Not recommended. This will suppress errors when Immy can&#39;t find a user to map a profile to.</td></tr><tr><td><strong>SkipDomainControllerLookup</strong></td><td>Use this in a hostile takeover situation where you are unable to install an agent on the domain controller. The domain controller is used to verify that user is active and still exists (to prevent trying to map profiles to users for employees that are no longer with the company)</td></tr><tr><td><strong>LimitToPrimaryUser</strong></td><td>This only works in Hybrid Joined environments! We ask Azure AD for the OnPremiseSecurityIdentifier of the primary user. Then we only migrate the profile associated to that user. This is useful if you don&#39;t want to have to exclude all profiles that can&#39;t be mapped.</td></tr><tr><td><strong>OAuthInfo</strong></td><td>Login using a device enrollment manager account in the target tenant. This must be a DEM User.</td></tr><tr><td><strong>CacheProvisioningPackage</strong></td><td></td></tr><tr><td><strong>SkipRegistryTest</strong></td><td>Skips registry validation and modification steps required for Azure AD Join. When not specified, the script performs checks for Azure AD Join-related registry settings, diagnoses potential issues with DSRegCmd and Intune enrollment states, and removes conflicting MDM policy enrollments.</td></tr><tr><td><strong>ClearExistingEnrollments</strong></td><td>Set this to clear all existing enrollments before joining (including User/Workplace Joins).</td></tr><tr><td><strong>UseEnhancedAzureADJoin</strong></td><td>Use certificate-based Azure AD Join instead of PPKG (BETA). Important: Test thoroughly before production use. Limitations: The following parameters are not supported with this option: • RequireInternetEnrollment • CacheProvisioningPackage</td></tr></tbody></table><h2 id="supported-migrations" tabindex="-1">Supported Migrations <a class="header-anchor" href="#supported-migrations" aria-label="Permalink to &quot;Supported Migrations&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Source ↓ Destination -&gt;</th><th>Workgroup</th><th>AzureAD</th><th>Active Directory</th></tr></thead><tbody><tr><td>Workgroup</td><td>Unsupported</td><td>Supported</td><td>Supported</td></tr><tr><td>AzureAD</td><td>Unsupported</td><td>Unsupported</td><td>Supported</td></tr><tr><td>Active Directory</td><td>Unsupported</td><td>Supported</td><td>Supported</td></tr></tbody></table><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><h2 id="azure-specific-issues" tabindex="-1">Azure Specific Issues <a class="header-anchor" href="#azure-specific-issues" aria-label="Permalink to &quot;Azure Specific Issues&quot;">​</a></h2><h3 id="join-issues" tabindex="-1">Join Issues <a class="header-anchor" href="#join-issues" aria-label="Permalink to &quot;Join Issues&quot;">​</a></h3><h4 id="mfa-prohibiting-aad-joins-0xcaa2000c" tabindex="-1">MFA Prohibiting AAD Joins (0xCAA2000C): <a class="header-anchor" href="#mfa-prohibiting-aad-joins-0xcaa2000c" aria-label="Permalink to &quot;MFA Prohibiting AAD Joins (0xCAA2000C):&quot;">​</a></h4><p>If your conditional access policies require MFA for all users, adjust the settings as follows:</p><ol><li><p>Exclude &#39;Microsoft Intune Enrollment&#39; from the Cloud Apps requiring MFA.</p></li><li><p>In Azure AD, create a Dynamic Security Group named &#39;Provisioning Packages&#39;. Set its Dynamic Membership Rule to: user.userPrincipalName -startsWith &quot;package_&quot;</p></li><li><p>Ensure that this &#39;Provisioning Packages&#39; group is excluded from the MFA requirement.</p></li></ol><h4 id="azure-syncfabric-app" tabindex="-1">Azure SyncFabric App <a class="header-anchor" href="#azure-syncfabric-app" aria-label="Permalink to &quot;Azure SyncFabric App&quot;">​</a></h4><p>This cloud app needs to exist for the task to run properly. Many new environments do not have the app when they are created, so you will need to create them. Microsoft has also been known to occasionally remove the app from tenants that already have it.</p><p>To add the cloud app to the desired tenant, run the following script:</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#Install-Module AzureAD #Uncomment this if you do not already have the AzureAD module installed</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Import-Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AzureAD</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Connect-AzureAd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TenantId </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">contoso.com</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Login as Global admin in customer tenant</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">New-AzureADServicePrincipal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AppId </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00000014</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">000000000000</span></span></code></pre></div><blockquote><p>⚠️ WARNING Replace the &quot;contoso.com&quot; domain with the one corresponding to your desired tenant.</p></blockquote><p>Alternatively, there is a cloud task that can add Azure SyncFabric back to the tenant. It may require a custom app registration, though.</p><h4 id="known-error-codes" tabindex="-1">Known Error Codes <a class="header-anchor" href="#known-error-codes" aria-label="Permalink to &quot;Known Error Codes&quot;">​</a></h4><h4 id="_0xcaa10059" tabindex="-1">0xCAA10059 <a class="header-anchor" href="#_0xcaa10059" aria-label="Permalink to &quot;0xCAA10059&quot;">​</a></h4><p>The account (DEM) you are using to enroll the device does not have permissions to join devices to Azure AD. Add the account to &#39;Selected Users&#39; or enable &#39;Allow All&#39; users to join devices at:</p><p><a href="https://aad.portal.azure.com/#view/Microsoft_AAD_Devices/DevicesMenuBlade/~/DeviceSettings" target="_blank" rel="noreferrer">Microsoft Entra ID - Device Settings</a></p><h4 id="_0xcaa50021" tabindex="-1">0xCAA50021 <a class="header-anchor" href="#_0xcaa50021" aria-label="Permalink to &quot;0xCAA50021&quot;">​</a></h4><p>The AAD Broker Plugin has been reset by us. You&#39;ll need to re-run the task if you see this.</p><h4 id="_0x8018000a" tabindex="-1">0x8018000A <a class="header-anchor" href="#_0x8018000a" aria-label="Permalink to &quot;0x8018000A&quot;">​</a></h4><p>The device is already enrolled by a user. Re-run with &#39;ClearExistingEnrollments&#39; set to &#39;True&#39;.</p><h4 id="_0x801c0024" tabindex="-1">0x801C0024 <a class="header-anchor" href="#_0x801c0024" aria-label="Permalink to &quot;0x801C0024&quot;">​</a></h4><p>The package_ AAD user associated with the PPKG was not found. Please run again with &#39;CacheProvisioningPackage&#39; set to &#39;False&#39; to generate a new package and user. This one shouldn&#39;t be an issue anymore, since we implemented retries that will generate a new package user if we are unable to create a token on the first try.</p><h4 id="_0x800700b7" tabindex="-1">0x800700B7 <a class="header-anchor" href="#_0x800700b7" aria-label="Permalink to &quot;0x800700B7&quot;">​</a></h4><p>The provisioning package already exists. This may happen if you have executed the provisioning package earlier on this machine.</p><h4 id="aadsts90092-or-aadsts90202" tabindex="-1">AADSTS90092 or AADSTS90202 <a class="header-anchor" href="#aadsts90092-or-aadsts90202" aria-label="Permalink to &quot;AADSTS90092 or AADSTS90202&quot;">​</a></h4><p>This tenant is missing the Microsoft.Graph.SyncFabric app (Microsoft stopped including it at some point in life)</p><p>Refer to <a href="https://community.immy.bot/t/everything-we-know-of-that-can-go-wrong-with-azuread/2669#p-5196-azure-syncfabric-app-5" target="_blank" rel="noreferrer">Azure SyncFabric App</a></p><h4 id="aadsts240005" tabindex="-1">AADSTS240005 <a class="header-anchor" href="#aadsts240005" aria-label="Permalink to &quot;AADSTS240005&quot;">​</a></h4><p>To correct this, navigate to <a href="https://aka.ms/in/#view/Microsoft_Intune_DeviceSettings/RolesLandingMenuBlade/~/roles" target="_blank" rel="noreferrer">Intune - Roles</a></p><p>Assign the Cloud Device Administrator or Cloud PC Administrator role to the DEM account you are using and try again.</p><h4 id="aadsts50126" tabindex="-1">AADSTS50126 <a class="header-anchor" href="#aadsts50126" aria-label="Permalink to &quot;AADSTS50126&quot;">​</a></h4><p>The credentials are invalid OR the user has not been excluded from your Registration Campaign</p><p><a href="https://entra.microsoft.com/#view/Microsoft_AAD_IAM/AuthenticationMethodsMenuBlade/~/RegistrationCampaign/fromNav/Identity" target="_blank" rel="noreferrer">Microsoft Entra Admin Center - Registration Campaign</a></p><h4 id="aadsts50055" tabindex="-1">AADSTS50055 <a class="header-anchor" href="#aadsts50055" aria-label="Permalink to &quot;AADSTS50055&quot;">​</a></h4><p>Reset the user&#39;s password via <a href="https://admin.microsoft.com" target="_blank" rel="noreferrer">Microsoft Admin Center</a></p><h4 id="aadsts240003" tabindex="-1">AADSTS240003 <a class="header-anchor" href="#aadsts240003" aria-label="Permalink to &quot;AADSTS240003&quot;">​</a></h4><p>This issue might be related to Multi-Factor Authentication (MFA) being enabled for $Username.</p><p>It&#39;s recommended to disable MFA for this account or consider using OAuth for a more secure authentication method.</p><h4 id="aadsts90002" tabindex="-1">AADSTS90002 <a class="header-anchor" href="#aadsts90002" aria-label="Permalink to &quot;AADSTS90002&quot;">​</a></h4><p>This error can typically be resolved by using the OAuth flow instead of the username/password flow.</p><p><br><br><br></p><div class="note custom-block github-alert"><p class="custom-block-title">Document information</p><p>Author: Mark Gomez and Brandon Ritchey <br> Date Published: 11/14/2025 <br> Date Revised: N/A <br> Version Number: 1.0</p></div>`,64)]))}const m=t(o,[["render",n]]);export{p as __pageData,m as default};
