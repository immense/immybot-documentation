import{_ as t,c as a,ah as r,o as i}from"./chunks/framework.BWXOFiC5.js";const p=JSON.parse('{"title":"Configure Directory","description":"","frontmatter":{},"headers":[],"relativePath":"Documentation/HowToGuides/Tasks/ConfigureDirectory.md","filePath":"Documentation/HowToGuides/Tasks/ConfigureDirectory.md"}'),o={name:"Documentation/HowToGuides/Tasks/ConfigureDirectory.md"};function n(s,e,l,d,h,c){return i(),a("div",null,e[0]||(e[0]=[r(`<h1 id="configure-directory" tabindex="-1">Configure Directory <a class="header-anchor" href="#configure-directory" aria-label="Permalink to &quot;Configure Directory&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>This document will go over setting up, using, and troubleshooting the task Configure Directory.</p><p>Configure Directory is a combination of <code>Set Computer Name and Domain Join</code> and <code>AzureAD Join</code>. We utilize the access that ImmyBot has to determine if you&#39;re tenants are using Active Directory, or AzureAD. Similar to Set Computer Name and Domain Join, you have the choice of joining a domain at all.</p><p>This task is intended to replace Join AzureAD and Set Computer Name and Domain Join. If you&#39;re trying to add a computer to a domain, change the name, etc, utilize this task.</p><h2 id="deployment-planning" tabindex="-1">Deployment Planning <a class="header-anchor" href="#deployment-planning" aria-label="Permalink to &quot;Deployment Planning&quot;">​</a></h2><p>You can set up a Cross Tenant deployment for local Active Directory joins, the task will automatically utilize the Domain Controller in the tenant. If you plan on doing any AzureAD Joining, you will need to set up a single tenant deployment per tenant.</p><p>If you only want to maintain a naming convention, just set DirectoryType to None, and set up your naming convention.</p><h2 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h2><p>An active ImmyBot subscription or <a href="https://www.immy.bot/pricing/" target="_blank" rel="noreferrer">trial</a></p><p>Permissions to configure Deployments</p><p>You will need to set up a DEM user for each of your tenants if you&#39;re planning on joining to AzureAD.</p><p>If you need to add the computers to AzureAD, you need to set up automatic <a href="https://learn.microsoft.com/en-us/intune/intune-service/enrollment/quickstart-setup-auto-enrollment" target="_blank" rel="noreferrer">Intune Enrollment</a></p><p>If you&#39;re using local Active Directory, you will need Domain Controllers with the permanent agent installed.</p><h3 id="dem-user-creation" tabindex="-1">DEM User Creation <a class="header-anchor" href="#dem-user-creation" aria-label="Permalink to &quot;DEM User Creation&quot;">​</a></h3><div class="info custom-block"><p class="custom-block-title">INFO</p><p>You only need to create DEM users if you&#39;re adding these computers to Azure.</p></div><div class="danger custom-block"><p class="custom-block-title">Do not use a Global Administrator</p><p>From a security standpoint, we do NOT recommend using a global admin or existing user as a DEM.</p></div><p>AzureAD/Entra Join DEM User Instructions</p><ol><li>Create a DEM (Device Enrollment Manager) user in the Customer&#39;s Azure AD (Ex. <a href="mailto:dem@contoso.com" target="_blank" rel="noreferrer">dem@contoso.com</a>)</li><li>Assign the DEM user an Intune license (Intune Plan 1 is fine)</li><li>Do NOT make the user a Global Admin (You shouldn&#39;t be bypassing MFA for Global Admins)</li><li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/RolesManagementMenuBlade/~/AllRoles/adminUnitObjectId//resourceScope/%2F" target="_blank" rel="noreferrer">Roles and administrators</a> and assign the Cloud Device Administrator or Cloud PC Administrator role</li><li>Go to <a href="https://intune.microsoft.com/#view/Microsoft_Intune_DeviceSettings/DevicesEnrollmentMenu/~/enrollmentManagers" target="_blank" rel="noreferrer">Device Enrollment Managers</a> and make the user a Device Enrollment Manager</li><li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_Devices/DevicesMenuBlade/~/DeviceSettings/menuId/" target="_blank" rel="noreferrer">MFA Enrollment</a> Settings and verify Require Multi-Factor Authentication to register or join devices with Azure AD is set to &quot;No&quot;</li><li>MANUALLY LOGON AS THE USER AN INCOGNITO WINDOW <ul><li>Verify a password change is not required</li></ul></li><li>Verify the user is not being prompted for MFA or MFA Registration</li></ol><h2 id="parameters" tabindex="-1">Parameters <a class="header-anchor" href="#parameters" aria-label="Permalink to &quot;Parameters&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Name</th><th>Description</th><th>Recommendation</th></tr></thead><tbody><tr><td>PrimaryPerson</td><td>This will be used to determine what software to install based on licensing in 365 and the groups the user is in.</td><td>For Cross Tenant Deployments, leave default</td></tr><tr><td>Directory Type</td><td>Choose is this is a local Active Directory, Azure Active Directory, or if you don&#39;t want this deployment to join a domain.</td><td>For Cross tenant Deployments, leave default</td></tr><tr><td>ComputerNameTemplate</td><td>The templated computer naming scheme for your tenants. Supports tokens, more information below</td><td>For Cross Tenant Deployments, utilize Tenant Slug where possible.</td></tr><tr><td>Username Template</td><td></td><td>Leave default</td></tr><tr><td>PreferredDomainControllerName</td><td>If you would like to specify a specific domain controller to use, configure that here</td><td>Leave default</td></tr><tr><td>CacheProvisioningPackage</td><td></td><td>Set to True</td></tr><tr><td>SkipRegistryTest</td><td>Skips registry validation and modification steps required for Azure AD Join.</td><td>Use this if registry settings are confirmed correct or for testing purposes, otherwise leave default</td></tr><tr><td>ClearExistingEnrollments</td><td>Set this to clear all existing enrollments before joining (including User/Workplace Joins).</td><td>Leave Default</td></tr><tr><td>UseEnhancedAzureADJoin</td><td>Use certificate based Azure AD join instead of PPKG.</td><td>Set up and enable</td></tr></tbody></table><h3 id="computer-name-template" tabindex="-1">Computer Name Template <a class="header-anchor" href="#computer-name-template" aria-label="Permalink to &quot;Computer Name Template&quot;">​</a></h3><p>Supported Tokens:</p><table tabindex="0"><thead><tr><th>Token</th><th>Example</th></tr></thead><tbody><tr><td>$TenantSlug</td><td>ABC (Specified under Tenant -&gt; Edit)</td></tr><tr><td>$FirstInitial</td><td>J</td></tr><tr><td>$FirstName</td><td>John</td></tr><tr><td>$LastName</td><td>Doe</td></tr><tr><td>$LastInitial</td><td>D</td></tr><tr><td>$Manufacturer</td><td>Dell, Lenovo, etc</td></tr><tr><td>$SerialNumber</td><td>Service Tag on Dell Devices, otherwise serial number on device</td></tr><tr><td>$FormFactorShort</td><td>PC/LPTP/SFC/VM</td></tr><tr><td>$FormFactorLong</td><td>DESKTOP/LAPTOP/ SURFACE/VIRTUAL</td></tr><tr><td>$Year</td><td>Current Year, 2025</td></tr><tr><td>$YearShort</td><td>Current Year, 25</td></tr><tr><td>$AssetTag</td><td>Enter manually</td></tr><tr><td>#</td><td>1</td></tr><tr><td>##</td><td>01</td></tr><tr><td>###</td><td>001</td></tr></tbody></table><h3 id="examples" tabindex="-1">Examples <a class="header-anchor" href="#examples" aria-label="Permalink to &quot;Examples&quot;">​</a></h3><p>$TenantSlug-$FormFactorShort-### -&gt; <code>ABC-PC-001</code></p><p>$TenantSlug-$FirstInitial$LastName -&gt; <code>ABC-JDOE</code></p><p>$SerialNumber-$Year-### -&gt; <code>ABC123-2025-001</code></p><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><h3 id="join-issues" tabindex="-1">Join Issues <a class="header-anchor" href="#join-issues" aria-label="Permalink to &quot;Join Issues&quot;">​</a></h3><h4 id="mfa-prohibiting-aad-joins-0xcaa2000c" tabindex="-1">MFA Prohibiting AAD Joins (0xCAA2000C): <a class="header-anchor" href="#mfa-prohibiting-aad-joins-0xcaa2000c" aria-label="Permalink to &quot;MFA Prohibiting AAD Joins (0xCAA2000C):&quot;">​</a></h4><p>If your conditional access policies require MFA for all users, adjust the settings as follows:</p><ol><li><p>Exclude &#39;Microsoft Intune Enrollment&#39; from the Cloud Apps requiring MFA.</p></li><li><p>In Azure AD, create a Dynamic Security Group named &#39;Provisioning Packages&#39;. Set its Dynamic Membership Rule to: user.userPrincipalName -startsWith &quot;package_&quot;</p></li><li><p>Ensure that this &#39;Provisioning Packages&#39; group is excluded from the MFA requirement.</p></li></ol><h4 id="azure-syncfabric-app" tabindex="-1">Azure SyncFabric App <a class="header-anchor" href="#azure-syncfabric-app" aria-label="Permalink to &quot;Azure SyncFabric App&quot;">​</a></h4><p>This cloud app needs to exist for the task to run properly. Many new environments do not have the app when they are created, so you will need to create them. Microsoft has also been known to occasionally remove the app from tenants that already have it.</p><p>To add the cloud app to the desired tenant, run the following script:</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#Install-Module AzureAD #Uncomment this if you do not already have the AzureAD module installed</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Import-Module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AzureAD</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Connect-AzureAd</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TenantId </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">contoso.com</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Login as Global admin in customer tenant</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">New-AzureADServicePrincipal</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">AppId </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00000014</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">000000000000</span></span></code></pre></div><blockquote><p>⚠️ WARNING Replace the &quot;contoso.com&quot; domain with the one corresponding to your desired tenant.</p></blockquote><p>Alternatively, there is a cloud task that can add Azure SyncFabric back to the tenant. It may require a custom app registration, though.</p><h4 id="known-error-codes" tabindex="-1">Known Error Codes <a class="header-anchor" href="#known-error-codes" aria-label="Permalink to &quot;Known Error Codes&quot;">​</a></h4><h4 id="_0xcaa10059" tabindex="-1">0xCAA10059 <a class="header-anchor" href="#_0xcaa10059" aria-label="Permalink to &quot;0xCAA10059&quot;">​</a></h4><p>The account (DEM) you are using to enroll the device does not have permissions to join devices to Azure AD. Add the account to &#39;Selected Users&#39; or enable &#39;Allow All&#39; users to join devices at:</p><p><a href="https://aad.portal.azure.com/#view/Microsoft_AAD_Devices/DevicesMenuBlade/~/DeviceSettings" target="_blank" rel="noreferrer">Microsoft Entra ID - Device Settings</a></p><h4 id="_0xcaa50021" tabindex="-1">0xCAA50021 <a class="header-anchor" href="#_0xcaa50021" aria-label="Permalink to &quot;0xCAA50021&quot;">​</a></h4><p>The AAD Broker Plugin has been reset by us. You&#39;ll need to re-run the task if you see this.</p><h4 id="_0x8018000a" tabindex="-1">0x8018000A <a class="header-anchor" href="#_0x8018000a" aria-label="Permalink to &quot;0x8018000A&quot;">​</a></h4><p>The device is already enrolled by a user. Re-run with &#39;ClearExistingEnrollments&#39; set to &#39;True&#39;.</p><h4 id="_0x801c0024" tabindex="-1">0x801C0024 <a class="header-anchor" href="#_0x801c0024" aria-label="Permalink to &quot;0x801C0024&quot;">​</a></h4><p>The package_ AAD user associated with the PPKG was not found. Please run again with &#39;CacheProvisioningPackage&#39; set to &#39;False&#39; to generate a new package and user. This one shouldn&#39;t be an issue anymore, since we implemented retries that will generate a new package user if we are unable to create a token on the first try.</p><h4 id="_0x800700b7" tabindex="-1">0x800700B7 <a class="header-anchor" href="#_0x800700b7" aria-label="Permalink to &quot;0x800700B7&quot;">​</a></h4><p>The provisioning package already exists. This may happen if you have executed the provisioning package earlier on this machine.</p><h4 id="aadsts90092-or-aadsts90202" tabindex="-1">AADSTS90092 or AADSTS90202 <a class="header-anchor" href="#aadsts90092-or-aadsts90202" aria-label="Permalink to &quot;AADSTS90092 or AADSTS90202&quot;">​</a></h4><p>This tenant is missing the Microsoft.Graph.SyncFabric app (Microsoft stopped including it at some point in life)</p><p>Refer to <a href="https://community.immy.bot/t/everything-we-know-of-that-can-go-wrong-with-azuread/2669#p-5196-azure-syncfabric-app-5" target="_blank" rel="noreferrer">Azure SyncFabric App</a></p><h4 id="aadsts240005" tabindex="-1">AADSTS240005 <a class="header-anchor" href="#aadsts240005" aria-label="Permalink to &quot;AADSTS240005&quot;">​</a></h4><p>To correct this, navigate to <a href="https://aka.ms/in/#view/Microsoft_Intune_DeviceSettings/RolesLandingMenuBlade/~/roles" target="_blank" rel="noreferrer">Intune - Roles</a></p><p>Assign the Cloud Device Administrator or Cloud PC Administrator role to the DEM account you are using and try again.</p><h4 id="aadsts50126" tabindex="-1">AADSTS50126 <a class="header-anchor" href="#aadsts50126" aria-label="Permalink to &quot;AADSTS50126&quot;">​</a></h4><p>The credentials are invalid OR the user has not been excluded from your Registration Campaign</p><p><a href="https://entra.microsoft.com/#view/Microsoft_AAD_IAM/AuthenticationMethodsMenuBlade/~/RegistrationCampaign/fromNav/Identity" target="_blank" rel="noreferrer">Microsoft Entra Admin Center - Registration Campaign</a></p><h4 id="aadsts50055" tabindex="-1">AADSTS50055 <a class="header-anchor" href="#aadsts50055" aria-label="Permalink to &quot;AADSTS50055&quot;">​</a></h4><p>Reset the user&#39;s password via <a href="https://admin.microsoft.com" target="_blank" rel="noreferrer">Microsoft Admin Center</a></p><h4 id="aadsts240003" tabindex="-1">AADSTS240003 <a class="header-anchor" href="#aadsts240003" aria-label="Permalink to &quot;AADSTS240003&quot;">​</a></h4><p>This issue might be related to Multi-Factor Authentication (MFA) being enabled for $Username.</p><p>It&#39;s recommended to disable MFA for this account or consider using OAuth for a more secure authentication method.</p><h4 id="aadsts90002" tabindex="-1">AADSTS90002 <a class="header-anchor" href="#aadsts90002" aria-label="Permalink to &quot;AADSTS90002&quot;">​</a></h4><p>This error can typically be resolved by using the OAuth flow instead of the username/password flow.</p><p><br><br><br></p><div class="note custom-block github-alert"><p class="custom-block-title">Document information</p><p>Author: <br> Date Published: <br> Date Revised: <br> Version Number:</p></div>`,69)]))}const m=t(o,[["render",n]]);export{p as __pageData,m as default};
